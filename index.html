<!DOCTYPE html>
<html>
<head>
  <title>Nouvelle vente</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #2F4F2F;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .wrapper {
      display: flex;
      gap: 60px;
      max-width: 1000px;
      width: 100%;
      height: 80vh;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 20px;
      box-sizing: border-box;
      align-items: center;
    }

    .container {
      flex: 1;
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: center;
    }

    th {
      background-color: #007AFF;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    select {
      padding: 5px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    #addRowBtn {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      align-self: flex-start;
      width: 150px;
      transition: background-color 0.3s ease;
    }
    #addRowBtn:hover {
      background-color: #1e7e34;
    }

    .sidebar {
      width: 180px;
      flex-shrink: 0;
      background: white;
      border: none;
      box-shadow: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    .sidebar button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      background-color: #FF3B30;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: background-color 0.3s ease;
    }
    .sidebar button:hover { background-color: #cc3027; }

    .sidebar .field {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
      padding: 0 6px;
    }
    .sidebar label {
      font-size: 14px;
      font-weight: 700;
      color: #111827;
    }
    .sidebar input[type="number"] {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .sum-box {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      padding: 15px;
      border: none;
      border-radius: 0;
      color: #007AFF;
      user-select: none;
      width: 100%;
      margin-bottom: 20px;
    }

    a.saved-link, a.stats-link {
      display: block;
      width: 100%;
      text-align: center;
      text-decoration: none;
      background-color: #007AFF;
      color: white;
      padding: 10px 0;
      border-radius: 5px;
      font-weight: 600;
      margin-top: 10px;
      transition: background-color 0.3s ease;
    }
    a.saved-link:hover, a.stats-link:hover { background-color: #005bb5; }
  </style>
</head>
<body>

  <div class="wrapper">
    <div class="container">
      <h1>Nouvelle vente</h1>
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Style</th>
            <th>Price per Unit</th>
            <th>Rabais (CHF)</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Rows generated by JS -->
        </tbody>
      </table>

      <button id="addRowBtn">Add More Rows</button>
    </div>

    <div class="sidebar">
      <button id="resetBtn">Reset Table</button>

      <!-- ðŸ†• Pourboire -->
      <div class="field">
        <label for="tipInput">Pourboire (CHF)</label>
        <input id="tipInput" type="number" min="0" max="50" step="1" value="0" />
      </div>

      <div class="sum-box">
        Total (CHF):<br />
        <span id="totalPrice">0</span>
      </div>

      <a href="saved.html" class="saved-link">Toutes les ventes</a>
      <a href="stats.html" class="stats-link">ðŸ“Š Statistiques</a>
    </div>
  </div>

  <script>
    const categories = ['Neuf', 'Occasion', 'Bar', 'Autres'];
    const styles = ['3CHF','Extra-EU','French/Recording','Hip-Hop','Electronic','Reggae/Dub','Rock','Jazz/Blues/Funk','Wave','Cassettes','T-shirt','Coffe'];
    const maxRows = 20;

    const tableBody = document.getElementById('tableBody');
    const totalPriceSpan = document.getElementById('totalPrice');
    const resetBtn = document.getElementById('resetBtn');
    const addRowBtn = document.getElementById('addRowBtn');
    const tipInput = document.getElementById('tipInput'); // ðŸ†•

    function makePlaceholderOption() {
      const opt = document.createElement('option');
      opt.value = "";
      opt.textContent = "-- select --";
      opt.selected = true;
      opt.disabled = true;
      return opt;
    }

    function createRow() {
      const row = document.createElement('tr');

      // Category
      const categoryCell = document.createElement('td');
      const categorySelect = document.createElement('select');
      categorySelect.appendChild(makePlaceholderOption());
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
      categoryCell.appendChild(categorySelect);
      row.appendChild(categoryCell);

      // Style
      const styleCell = document.createElement('td');
      const styleSelect = document.createElement('select');
      styleSelect.appendChild(makePlaceholderOption());
      styles.forEach(st => {
        const option = document.createElement('option');
        option.value = st;
        option.textContent = st;
        styleSelect.appendChild(option);
      });
      styleCell.appendChild(styleSelect);
      row.appendChild(styleCell);

      // Price
      const priceCell = document.createElement('td');
      const priceSelect = document.createElement('select');
      priceSelect.appendChild(makePlaceholderOption());
      for (let price = 1; price <= 200; price++) {
        const option = document.createElement('option');
        option.value = price;
        option.textContent = price;
        priceSelect.appendChild(option);
      }
      priceCell.appendChild(priceSelect);
      row.appendChild(priceCell);

      // Rabais (0 â†’ 10)
      const discountCell = document.createElement('td');
      const discountSelect = document.createElement('select');
      discountSelect.appendChild(makePlaceholderOption());
      for (let d = 0; d <= 10; d++) {
        const option = document.createElement('option');
        option.value = d;
        option.textContent = d;
        discountSelect.appendChild(option);
      }
      discountCell.appendChild(discountSelect);
      row.appendChild(discountCell);

      // Update total when price/discount changes
      priceSelect.addEventListener('change', updateTotal);
      discountSelect.addEventListener('change', updateTotal);

      return row;
    }

    // Initial rows
    for (let i = 0; i < maxRows; i++) {
      tableBody.appendChild(createRow());
    }

    function computeSubtotalNet(){
      let subtotal = 0;
      const rows = tableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const priceSelect = row.cells[2].querySelector('select');    // Price
        const discountSelect = row.cells[3].querySelector('select'); // Rabais
        if (priceSelect && priceSelect.value) {
          const price = Number(priceSelect.value);
          const discount = discountSelect && discountSelect.value ? Number(discountSelect.value) : 0;
          subtotal += Math.max(price - discount, 0);
        }
      });
      return subtotal;
    }

    function updateTotal() {
      const tip = Number(tipInput.value) || 0;
      const total = computeSubtotalNet() + tip;
      totalPriceSpan.textContent = total;
    }

    // Save current snapshot (with tip)
    function saveSnapshot() {
      const rows = tableBody.querySelectorAll('tr');
      let snapshot = {
        time: new Date().toISOString(),
        tip: Number(tipInput.value) || 0, // ðŸ†• pourboire au niveau du snapshot
        entries: []
      };
      rows.forEach(row => {
        const categorySelect = row.cells[0].querySelector('select');
        const styleSelect = row.cells[1].querySelector('select');
        const priceSelect = row.cells[2].querySelector('select');
        const discountSelect = row.cells[3].querySelector('select');
        if (categorySelect.value && styleSelect.value && priceSelect.value) {
          snapshot.entries.push({
            category: categorySelect.value,
            style: styleSelect.value,
            price: Number(priceSelect.value),
            discount: discountSelect && discountSelect.value ? Number(discountSelect.value) : 0
          });
        }
      });
      if (snapshot.entries.length === 0) return;
      let savedSnapshots = JSON.parse(localStorage.getItem('savedSnapshots') || "[]");
      savedSnapshots.push(snapshot);
      localStorage.setItem('savedSnapshots', JSON.stringify(savedSnapshots));
    }

    // Listeners
    tipInput.addEventListener('input', updateTotal); // ðŸ†•

    resetBtn.addEventListener('click', () => {
      saveSnapshot();
      const rows = tableBody.querySelectorAll('tr');
      rows.forEach(row => {
        row.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);
      });
      tipInput.value = 0; // reset du pourboire
      updateTotal();
    });

    addRowBtn.addEventListener('click', () => {
      for (let i = 0; i < 10; i++) {
        tableBody.appendChild(createRow());
      }
    });

    // Initial calc
    updateTotal();
  </script>

</body>
</html>
