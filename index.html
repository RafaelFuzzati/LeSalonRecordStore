<!DOCTYPE html>
<html>
<head>
  <title>Nouvelle vente</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #2F4F2F;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .wrapper {
      display: flex;
      gap: 60px;
      max-width: 1000px;
      width: 100%;
      height: 80vh;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 20px;
      box-sizing: border-box;
      align-items: center;
    }

    .container {
      flex: 1;
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: center;
    }

    th {
      background-color: #007AFF;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    select {
      padding: 5px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    #addRowBtn {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      align-self: flex-start;
      width: 150px;
      transition: background-color 0.3s ease;
    }
    #addRowBtn:hover {
      background-color: #1e7e34;
    }

    .sidebar {
      width: 200px;
      flex-shrink: 0;
      background: white;
      border: none;
      box-shadow: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      height: 100%;
      gap: 12px;
    }

    .sidebar button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      background-color: #FF3B30;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s ease;
    }
    .sidebar button:hover { background-color: #cc3027; }

    .sidebar .field {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 4px;
      padding: 0 6px;
    }
    .sidebar label {
      font-size: 14px;
      font-weight: 700;
      color: #111827;
      text-align: center;
    }

    .sum-box {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      padding: 15px;
      border: none;
      border-radius: 0;
      color: #007AFF;
      user-select: none;
      width: 100%;
    }

    a.saved-link, a.stats-link {
      display: block;
      width: 100%;
      text-align: center;
      text-decoration: none;
      background-color: #007AFF;
      color: white;
      padding: 10px 0;
      border-radius: 5px;
      font-weight: 600;
      margin-top: 10px;
      transition: background-color 0.3s ease;
    }
    a.saved-link:hover, a.stats-link:hover { background-color: #005bb5; }
  </style>
</head>
<body>

  <div class="wrapper">
    <div class="container">
      <h1>Nouvelle vente</h1>
      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Style</th>
            <th>Price per Unit</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <button id="addRowBtn">Add More Rows</button>
    </div>

    <div class="sidebar">
      <button id="resetBtn">ðŸ’¾ Sauvegarder</button>

      <div class="field">
        <label for="discountSelect">Rabais (CHF)</label>
        <select id="discountSelect">
          <option value="0" selected>0</option>
        </select>
      </div>

      <div class="sum-box">
        Total (CHF):<br />
        <span id="totalPrice">0</span>
      </div>

      <a href="saved.html" class="saved-link">Toutes les ventes</a>
      <a href="stats.html" class="stats-link">ðŸ“Š Statistiques</a>
    </div>
  </div>

  <script>
    const categories = [
      'Vinyls Neuf',
      'Vinyls Occasion',
      'Cassettes',
      'Merch',
      'Bar'
    ];

    const stylesByCategory = {
      'Vinyls Neuf': ['3CHF','Extra-EU','French/Recording','Hip-Hop','Electronic','Reggae/Dub','Rock','Jazz/Blues/Funk','Wave'],
      'Vinyls Occasion': ['3CHF','Extra-EU','French/Recording','Hip-Hop','Electronic','Reggae/Dub','Rock','Jazz/Blues/Funk','Wave'],
      'Cassettes': ['3CHF','Extra-EU','French/Recording','Hip-Hop','Electronic','Reggae/Dub','Rock','Jazz/Blues/Funk','Wave'],
      'Merch': ['Tshirt', 'Poids', 'Diamants', 'Bon cadeau'],
      'Bar': ['Caffe']
    };

    const maxRows = 20;

    const tableBody = document.getElementById('tableBody');
    const totalPriceSpan = document.getElementById('totalPrice');
    const resetBtn = document.getElementById('resetBtn');
    const addRowBtn = document.getElementById('addRowBtn');
    const discountSelect = document.getElementById('discountSelect');

    for (let v = 1; v <= 20; v++) {
      const opt1 = document.createElement('option');
      opt1.value = v;
      opt1.textContent = v;
      discountSelect.appendChild(opt1);
    }

    function makePlaceholderOption() {
      const opt = document.createElement('option');
      opt.value = "";
      opt.textContent = "-- select --";
      opt.selected = true;
      opt.disabled = true;
      return opt;
    }

    function createRow() {
      const row = document.createElement('tr');

      const categoryCell = document.createElement('td');
      const categorySelect = document.createElement('select');
      categorySelect.appendChild(makePlaceholderOption());
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
      categoryCell.appendChild(categorySelect);
      row.appendChild(categoryCell);

      const styleCell = document.createElement('td');
      const styleSelect = document.createElement('select');
      styleSelect.appendChild(makePlaceholderOption());
      styleCell.appendChild(styleSelect);
      row.appendChild(styleCell);

      const priceCell = document.createElement('td');
      const priceSelect = document.createElement('select');
      priceSelect.appendChild(makePlaceholderOption());
      for (let price = 1; price <= 200; price++) {
        const option = document.createElement('option');
        option.value = price;
        option.textContent = price;
        priceSelect.appendChild(option);
      }
      priceCell.appendChild(priceSelect);
      row.appendChild(priceCell);

      categorySelect.addEventListener('change', () => {
        styleSelect.innerHTML = '';
        styleSelect.appendChild(makePlaceholderOption());

        const styles = stylesByCategory[categorySelect.value] || [];
        styles.forEach(st => {
          const option = document.createElement('option');
          option.value = st;
          option.textContent = st;
          styleSelect.appendChild(option);
        });
      });

      priceSelect.addEventListener('change', updateTotal);

      return row;
    }

    for (let i = 0; i < maxRows; i++) tableBody.appendChild(createRow());

    function computeSubtotal() {
      let subtotal = 0;
      tableBody.querySelectorAll('tr').forEach(row => {
        const priceSelect = row.cells[2].querySelector('select');
        if (priceSelect && priceSelect.value) subtotal += Number(priceSelect.value);
      });
      return subtotal;
    }

    function updateTotal() {
      const subtotal = computeSubtotal();
      const rabais = Number(discountSelect.value) || 0;
      const total = Math.max(subtotal - rabais, 0);
      totalPriceSpan.textContent = total;
    }

    function saveSnapshot() {
      const rows = tableBody.querySelectorAll('tr');
      let snapshot = {
        time: new Date().toISOString(),
        discount: Number(discountSelect.value) || 0,
        entries: []
      };
      rows.forEach(row => {
        const cat = row.cells[0].querySelector('select').value;
        const style = row.cells[1].querySelector('select').value;
        const price = row.cells[2].querySelector('select').value;
        if (cat && style && price) {
          snapshot.entries.push({ category: cat, style: style, price: Number(price) });
        }
      });
      if (snapshot.entries.length === 0) return;
      const saved = JSON.parse(localStorage.getItem('savedSnapshots') || "[]");
      saved.push(snapshot);
      localStorage.setItem('savedSnapshots', JSON.stringify(saved));
    }

    discountSelect.addEventListener('change', updateTotal);

    resetBtn.addEventListener('click', () => {
      saveSnapshot();
      tableBody.querySelectorAll('select').forEach(sel => (sel.selectedIndex = 0));
      discountSelect.value = "0";
      updateTotal();
    });

    addRowBtn.addEventListener('click', () => {
      for (let i = 0; i < 10; i++) tableBody.appendChild(createRow());
    });

    updateTotal();
  </script>
</body>
</html>
