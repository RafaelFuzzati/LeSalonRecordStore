<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Statistiques des ventes</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#2F4F2F; --card:#fff; --ink:#1f2937; --muted:#6b7280;
      --accent:#f472b6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --bar:#60a5fa; --bar2:#f97316; --chip:#111827;
    }
    *{box-sizing:border-box}
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin:0; padding:20px; background:var(--bg); color:#fff; min-height:100vh;
    }
    a.back-link{color:#f9a8d4; text-decoration:none; font-weight:600}
    a.back-link:hover{text-decoration:underline}
    h1{margin:10px 0 16px; text-align:center; color:#f9a8d4}
    .controls{display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; margin:10px 0 18px}
    .controls label{color:#fff}
    .controls select{
      padding:10px 12px; border-radius:10px; border:none; font-size:14px;
      background:#fff; color:#111827; font-weight:600;
    }

    /* Layout */
    .grid{display:grid; gap:16px}
    .kpis{grid-template-columns:repeat(3,minmax(0,1fr))}
    .two-col{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width: 900px){ .kpis,.two-col{grid-template-columns:1fr} }

    .card{
      background:var(--card); color:var(--ink);
      border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.15);
    }
    .card h3{margin:0 0 12px; font-size:16px; color:var(--muted); font-weight:700; letter-spacing:.02em}
    .kpi-value{font-size:28px; font-weight:800}
    .kpi-sub{color:var(--muted); font-size:12px; margin-top:4px}

    /* Listes + barres CSS */
    .list{display:flex; flex-direction:column; gap:10px}
    .row{
      display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center;
    }
    .row .name{font-weight:700}
    .row .nums{font-variant-numeric:tabular-nums; text-align:right; white-space:nowrap}
    .row .nums small{color:var(--muted)}
    .barwrap{grid-column:1/-1; background:#f3f4f6; border-radius:999px; overflow:hidden; height:10px}
    .bar{height:100%; background:linear-gradient(90deg,var(--bar),var(--bar2))}
    
    /* Calendar heatmap */
    .calendar{
      display:grid; grid-template-columns:repeat(7,1fr); gap:6px;
    }
    .day{
      background:#0b1220; color:#fff; border-radius:10px; padding:10px; text-align:center;
      aspect-ratio:1/1; display:flex; flex-direction:column; justify-content:center; align-items:center;
      transition:transform .1s ease; cursor:pointer;
    }
    .day:hover{transform:translateY(-2px)}
    .day .d{font-weight:800}
    .day .v{margin-top:4px; font-size:12px; color:#e5e7eb}
    .legend{display:flex; align-items:center; gap:8px; color:#e5e7eb; font-size:12px}
    .swatch{width:18px; height:10px; border-radius:999px; background:#0b1220}
    .swatch.s1{background:#134e4a} .swatch.s2{background:#0ea5e9}
    .swatch.s3{background:#f59e0b} .swatch.s4{background:#ef4444}

    /* Chips */
    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      background:var(--chip); color:#fff; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700
    }

    /* Tables simples */
    .mini-list{display:flex; flex-direction:column; gap:8px}
    .mini-row{display:flex; align-items:center; justify-content:space-between}
    .mini-row .left{display:flex; align-items:center; gap:8px}
    .badge{background:#0b1220; color:#fff; font-weight:800; font-size:12px; padding:4px 8px; border-radius:8px}

    /* Footer total mois */
    .total-month{
      text-align:center; font-weight:800; color:#fff; margin:8px 0 0; font-size:18px
    }
  </style>
</head>
<body>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
    <div class="left-nav">
      <a href="index.html" class="back-link">&larr; Nouvelle vente</a> |
      <a href="all.html" class="back-link">ðŸ§¾ Toutes les ventes</a>
    </div>
    <div class="legend">
      IntensitÃ© du jour &nbsp;
      <span class="swatch"></span><span class="swatch s1"></span>
      <span class="swatch s2"></span><span class="swatch s3"></span><span class="swatch s4"></span>
    </div>
  </div>

  <h1>Statistiques des ventes</h1>

  <div class="controls">
    <label for="monthSelect">SÃ©lectionnez un mois :</label>
    <select id="monthSelect"></select>
  </div>

  <!-- KPI -->
  <section class="grid kpis" id="kpiGrid">
    <div class="card"><h3>Total CHF</h3><div class="kpi-value" id="kpiTotal">â€”</div><div class="kpi-sub" id="kpiAvgDay">â€”</div></div>
    <div class="card"><h3>Disques vendus</h3><div class="kpi-value" id="kpiCount">â€”</div><div class="kpi-sub" id="kpiAvgTicket">â€”</div></div>
    <div class="card"><h3>CatÃ©gories actives</h3><div class="kpi-value" id="kpiCats">â€”</div><div class="kpi-sub" id="kpiStyles">â€”</div></div>
  </section>

  <!-- Calendar + Top days -->
  <section class="grid two-col">
    <div class="card">
      <h3>Calendrier du mois (CHF par jour)</h3>
      <div id="calendar" class="calendar"></div>
    </div>
    <div class="card">
      <h3>Meilleurs jours</h3>
      <div id="topDays" class="mini-list"></div>
      <div style="height:8px"></div>
      <h3>Ventes rÃ©centes</h3>
      <div id="recentSales" class="mini-list"></div>
    </div>
  </section>

  <!-- Category / Style breakdown -->
  <section class="grid two-col">
    <div class="card">
      <h3>RÃ©partition par catÃ©gorie</h3>
      <div id="catChips" class="chips"></div>
      <div style="height:8px"></div>
      <div id="catList" class="list"></div>
    </div>
    <div class="card">
      <h3>RÃ©partition par style</h3>
      <div id="styleChips" class="chips"></div>
      <div style="height:8px"></div>
      <div id="styleList" class="list"></div>
    </div>
  </section>

  <div id="totalMonth" class="total-month"></div>

  <script>
    // --- Helpers ---
    const CHF = n => new Intl.NumberFormat('fr-CH',{style:'currency',currency:'CHF',maximumFractionDigits:2}).format(n);
    const pad = n => String(n).padStart(2,'0');

    // Data source
    const snapshots = JSON.parse(localStorage.getItem("savedSnapshots") || "[]");
    const monthSelect = document.getElementById("monthSelect");

    function monthKeyFromDate(d){ return d.getFullYear()+"-"+pad(d.getMonth()+1); }
    function toDayKey(d){ return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate()); }

    // Fill month dropdown
    (function populateMonths(){
      const set = new Set(snapshots.map(s => monthKeyFromDate(new Date(s.time))));
      const months = Array.from(set).sort().reverse();
      monthSelect.innerHTML = "";
      months.forEach(m=>{
        const [y,mo] = m.split("-");
        const op = document.createElement("option");
        op.value = m; op.textContent = `${mo}/${y}`;
        monthSelect.appendChild(op);
      });
      if(!months.length){
        const op = document.createElement("option");
        op.value=""; op.textContent="(aucune donnÃ©e)";
        monthSelect.appendChild(op);
      }
    })();

    const els = {
      kpiTotal: document.getElementById("kpiTotal"),
      kpiAvgDay: document.getElementById("kpiAvgDay"),
      kpiCount: document.getElementById("kpiCount"),
      kpiAvgTicket: document.getElementById("kpiAvgTicket"),
      kpiCats: document.getElementById("kpiCats"),
      kpiStyles: document.getElementById("kpiStyles"),
      calendar: document.getElementById("calendar"),
      topDays: document.getElementById("topDays"),
      recentSales: document.getElementById("recentSales"),
      catChips: document.getElementById("catChips"),
      catList: document.getElementById("catList"),
      styleChips: document.getElementById("styleChips"),
      styleList: document.getElementById("styleList"),
      totalMonth: document.getElementById("totalMonth"),
    };

    function filterByMonth(mkey){
      return snapshots.filter(s=>{
        const d = new Date(s.time);
        return monthKeyFromDate(d) === mkey;
      });
    }

    function summarize(data){
      const byDay = {};
      const byCatC = {}, byCatS = {};
      const byStyleC = {}, byStyleS = {};
      const recent = [];

      let totalSales=0, totalCount=0;
      data.forEach(s=>{
        const d = new Date(s.time);
        const dayKey = toDayKey(d);
        let sub=0, cnt=0;
        s.entries.forEach(e=>{
          const price = parseFloat(e.price)||0;
          const cat = e.category || "â€”";
          const st = e.style || "â€”";
          totalSales += price; totalCount++;
          sub += price; cnt++;

          byCatC[cat]=(byCatC[cat]||0)+1;
          byCatS[cat]=(byCatS[cat]||0)+price;

          byStyleC[st]=(byStyleC[st]||0)+1;
          byStyleS[st]=(byStyleS[st]||0)+price;
        });
        if(!byDay[dayKey]) byDay[dayKey]={ total:0, count:0, snaps:[] };
        byDay[dayKey].total+=sub; byDay[dayKey].count+=cnt;
        byDay[dayKey].snaps.push({time:s.time, subtotal:sub, count:cnt, entries:s.entries});
        recent.push({time:s.time, subtotal:sub, count:cnt});
      });

      return {
        totalSales, totalCount, byDay, byCatC, byCatS, byStyleC, byStyleS,
        recent: recent.sort((a,b)=> new Date(b.time)-new Date(a.time)).slice(0,6)
      };
    }

    function renderKPI(sum, mkey){
      const days = Object.keys(sum.byDay).length || 1;
      els.kpiTotal.textContent = CHF(sum.totalSales);
      els.kpiAvgDay.textContent = `Moyenne par jour: ${CHF(sum.totalSales/days)}`;
      els.kpiCount.textContent = sum.totalCount.toString();
      els.kpiAvgTicket.textContent = `Ticket moyen: ${sum.totalCount? CHF(sum.totalSales/sum.totalCount): 'â€”'}`;
      els.kpiCats.textContent = Object.keys(sum.byCatC).length.toString();
      els.kpiStyles.textContent = `Styles: ${Object.keys(sum.byStyleC).length}`;
      const [y,mo] = mkey.split("-");
      els.totalMonth.textContent = `Total ${mo}/${y} â€” ${sum.totalCount} disques | ${CHF(sum.totalSales)}`;
    }

    function renderCalendar(sum, mkey){
      const [y,mo] = mkey.split("-").map(n=>parseInt(n,10));
      const first = new Date(y, mo-1, 1);
      const last = new Date(y, mo, 0);
      const startOffset = (first.getDay()+6)%7; // start week on Monday

      // compute max for scale
      const vals = Object.values(sum.byDay).map(d=>d.total);
      const max = Math.max(1, ...vals);

      els.calendar.innerHTML = "";
      // empty boxes before 1st
      for(let i=0;i<startOffset;i++){
        const emp = document.createElement("div");
        emp.className="day"; emp.style.visibility="hidden";
        els.calendar.appendChild(emp);
      }
      // days
      for(let day=1; day<= last.getDate(); day++){
        const key = `${y}-${pad(mo)}-${pad(day)}`;
        const info = sum.byDay[key] || {total:0, count:0};
        const intensity = info.total/max; // 0..1
        const bg = intensity===0 ? "#0b1220"
          : intensity<.25 ? "#134e4a"
          : intensity<.5 ? "#0ea5e9"
          : intensity<.8 ? "#f59e0b"
          : "#ef4444";

        const box = document.createElement("div");
        box.className="day";
        box.style.background = bg;
        box.title = `${key} â€¢ ${info.count} disques â€” ${CHF(info.total)}`;
        box.innerHTML = `<div class="d">${day}</div><div class="v">${info.count} | ${CHF(info.total)}</div>`;
        box.addEventListener("click", ()=>{
          // scroll to Top Days and highlight this day
          const rows = [...document.querySelectorAll('[data-dayrow]')];
          rows.forEach(r=> r.style.outline = (r.dataset.dayrow===key ? '2px solid #f59e0b' : 'none'));
          document.getElementById("topDays").scrollIntoView({behavior:'smooth', block:'center'});
        });
        els.calendar.appendChild(box);
      }
    }

    function makeChip(txt){ const c=document.createElement('span'); c.className='chip'; c.textContent=txt; return c; }

    function renderBreakdown(containerList, containerChips, counts, sums, totalSales, totalCount){
      const items = Object.keys(counts).map(k=>({
        name:k, count:counts[k], sum:sums[k]||0
      })).sort((a,b)=> b.sum - a.sum);

      containerList.innerHTML = "";
      containerChips.innerHTML = "";

      // chips: top 5
      items.slice(0,5).forEach(i=>{
        containerChips.appendChild(makeChip(`${i.name}: ${i.count} â€¢ ${CHF(i.sum)}`));
      });

      const maxSum = Math.max(1, ...items.map(i=>i.sum));
      items.forEach(i=>{
        const row = document.createElement('div');
        row.className = 'row';
        const share = totalSales? (i.sum/totalSales*100):0;
        row.innerHTML = `
          <div class="name">${i.name}</div>
          <div class="nums"><strong>${i.count}</strong> <small>disques</small></div>
          <div class="nums"><strong>${CHF(i.sum)}</strong> <small>${share.toFixed(1)}%</small></div>
          <div class="barwrap"><div class="bar" style="width:${(i.sum/maxSum*100).toFixed(0)}%"></div></div>
        `;
        containerList.appendChild(row);
      });
    }

    function renderTopDays(sum){
      const days = Object.entries(sum.byDay).map(([k,v])=>({day:k, ...v}))
        .sort((a,b)=> b.total - a.total).slice(0,6);
      els.topDays.innerHTML = "";
      days.forEach((d,idx)=>{
        const r = document.createElement('div');
        r.className = 'mini-row'; r.dataset.dayrow = d.day;
        const date = new Date(d.day+"T00:00:00");
        const label = date.toLocaleDateString('fr-CH',{weekday:'short', day:'2-digit', month:'2-digit'});
        r.innerHTML = `
          <div class="left"><span class="badge">#${idx+1}</span> <strong>${label}</strong></div>
          <div><strong>${d.count}</strong> disques â€” <strong>${CHF(d.total)}</strong></div>
        `;
        els.topDays.appendChild(r);
      });
    }

    function renderRecent(sum){
      els.recentSales.innerHTML = "";
      sum.recent.forEach(r=>{
        const d = new Date(r.time);
        const label = d.toLocaleString('fr-CH', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
        const row = document.createElement('div');
        row.className = 'mini-row';
        row.innerHTML = `<div class="left"><span class="badge">${r.count}</span> <strong>${label}</strong></div>
                         <div><strong>${CHF(r.subtotal)}</strong></div>`;
        els.recentSales.appendChild(row);
      });
    }

    function renderAll(){
      const mkey = monthSelect.value || monthKeyFromDate(new Date());
      const data = filterByMonth(mkey);
      const sum = summarize(data);
      renderKPI(sum, mkey);
      renderCalendar(sum, mkey);
      renderBreakdown(els.catList, els.catChips, sum.byCatC, sum.byCatS, sum.totalSales, sum.totalCount);
      renderBreakdown(els.styleList, els.styleChips, sum.byStyleC, sum.byStyleS, sum.totalSales, sum.totalCount);
      renderTopDays(sum);
      renderRecent(sum);
    }

    monthSelect.addEventListener('change', renderAll);
    renderAll();
  </script>
</body>
</html>
