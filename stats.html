<section class="section card">
  <h3>Ventes ce mois (calendrier)</h3>
  <div id="calendar" class="calendar"></div>
  <div class="hint">Chaque case correspond à un jour du mois (Lun → Dim).</div>
</section>

<style>
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
  }
  .cal-head {
    text-align: center;
    font-weight: 700;
    font-size: 12px;
    color: #e5e7eb;
    margin-bottom: 4px;
  }
  .day {
    background: #0b1220;
    color: #fff;
    border-radius: 10px;
    padding: 8px;
    text-align: center;
    min-height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 4px;
    font-size: 12px;
  }
  .day.empty {
    background: transparent;
    box-shadow: none;
  }
  .dow {
    font-size: 11px;
    color: #e5e7eb;
    font-weight: 600;
  }
  .d {
    font-weight: 900;
    font-size: 16px;
  }
  .v {
    font-size: 11px;
    color: #f1f5f9;
  }
  .lv0 { background:#0b1220 }
  .lv1 { background:#134e4a }
  .lv2 { background:#0ea5e9 }
  .lv3 { background:#f59e0b }
  .lv4 { background:#ef4444 }
</style>

<script>
  const dayNames = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];

  function renderCalendar(sum, mkey){
    els.calendar.innerHTML = "";
    const [y,mo] = mkey.split("-").map(Number);
    const first = new Date(y, mo-1, 1);
    const last = new Date(y, mo, 0);

    // titres colonnes (jours de la semaine)
    dayNames.forEach(dn=>{
      const head = document.createElement("div");
      head.className = "cal-head";
      head.textContent = dn;
      els.calendar.appendChild(head);
    });

    // remplissage avec cases vides jusqu'au premier jour
    let startDay = (first.getDay()+6)%7; // Lundi=0
    for(let i=0; i<startDay; i++){
      const empty = document.createElement("div");
      empty.className="day empty";
      els.calendar.appendChild(empty);
    }

    // max valeur pour intensité couleurs
    const totals = Object.values(sum.byDay).map(d=>d.total);
    const max = Math.max(1, ...totals);

    // jours du mois
    for(let day=1; day<=last.getDate(); day++){
      const d = new Date(y, mo-1, day);
      const key = toDayKey(d);
      const info = sum.byDay[key] || {total:0, count:0};
      const ratio = info.total/max;
      const lv = ratio===0 ? 0 : ratio<.25 ? 1 : ratio<.5 ? 2 : ratio<.8 ? 3 : 4;

      const box = document.createElement("div");
      box.className = `day lv${lv}`;
      box.title = `${dayNames[(d.getDay()+6)%7]} ${key} • ${info.count} disques — ${CHF(info.total)}`;
      box.innerHTML = `
        <div class="d">${day}</div>
        <div class="v">${info.count} | ${CHF(info.total)}</div>
      `;
      els.calendar.appendChild(box);
    }
  }
</script>
