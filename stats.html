<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Statistiques des ventes</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #2F4F2F;
      min-height: 100vh;
      color: white;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    a.back-link {
      display: inline-block;
      margin-bottom: 15px;
      color: #007AFF;
      text-decoration: none;
      font-weight: 600;
    }
    a.back-link:hover {
      text-decoration: underline;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .chart-container h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #007AFF;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-link">&larr; Retour</a>
  <h1>Statistiques des ventes</h1>

  <div class="chart-container">
    <h2>Ventes par Catégorie</h2>
    <canvas id="categoryChart"></canvas>
  </div>

  <div class="chart-container">
    <h2>Ventes par Style</h2>
    <canvas id="styleChart"></canvas>
  </div>

  <div class="chart-container">
    <h2>Évolution Mensuelle</h2>
    <canvas id="monthlyChart"></canvas>
  </div>

  <div class="chart-container">
    <h2>Total des ventes</h2>
    <p id="globalTotal" style="text-align:center;font-size:1.5rem;color:#007AFF;font-weight:bold;"></p>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let snapshots = JSON.parse(localStorage.getItem('savedSnapshots') || "[]");

    // Prepare data
    let categoryCounts = {};
    let styleCounts = {};
    let monthlyTotals = {};
    let globalTotal = 0;

    snapshots.forEach(snapshot => {
      const date = new Date(snapshot.time);
      const monthKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;

      snapshot.entries.forEach(entry => {
        const price = parseFloat(entry.price) || 0;
        globalTotal += price;

        // Category
        categoryCounts[entry.category] = (categoryCounts[entry.category] || 0) + price;

        // Style
        styleCounts[entry.style || "Autre"] = (styleCounts[entry.style || "Autre"] || 0) + price;

        // Monthly
        monthlyTotals[monthKey] = (monthlyTotals[monthKey] || 0) + price;
      });
    });

    // Render Category chart
    new Chart(document.getElementById('categoryChart'), {
      type: 'pie',
      data: {
        labels: Object.keys(categoryCounts),
        datasets: [{
          data: Object.values(categoryCounts),
          backgroundColor: ['#007AFF','#28a745','#FF3B30','#FF9500']
        }]
      }
    });

    // Render Style chart
    new Chart(document.getElementById('styleChart'), {
      type: 'bar',
      data: {
        labels: Object.keys(styleCounts),
        datasets: [{
          label: 'Ventes (€)',
          data: Object.values(styleCounts),
          backgroundColor: '#007AFF'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    // Render Monthly chart
    const sortedMonths = Object.keys(monthlyTotals).sort();
    new Chart(document.getElementById('monthlyChart'), {
      type: 'line',
      data: {
        labels: sortedMonths,
        datasets: [{
          label: 'Total mensuel (€)',
          data: sortedMonths.map(m => monthlyTotals[m]),
          borderColor: '#28a745',
          fill: false
        }]
      }
    });

    // Show global total
    document.getElementById('globalTotal').textContent = `Total global : €${globalTotal.toFixed(2)}`;
  </script>
</body>
</html>
