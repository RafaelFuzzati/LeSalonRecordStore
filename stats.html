<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Statistiques des ventes</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#2F4F2F; --card:#fff; --ink:#1f2937; --muted:#6b7280;
      --accent:#f472b6; --bar:#60a5fa; --bar2:#f97316;
    }
    *{box-sizing:border-box}
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin:0; padding:20px; background:var(--bg); color:#fff; min-height:100vh;
    }
    a.back-link{color:#f9a8d4; text-decoration:none; font-weight:600}
    a.back-link:hover{text-decoration:underline}
    h1{margin:10px 0 16px; text-align:center; color:#f9a8d4}
    .controls{display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; margin:10px 0 18px}
    .controls label{color:#fff}
    .controls select{
      padding:10px 12px; border-radius:10px; border:none; font-size:14px;
      background:#fff; color:#111827; font-weight:600;
    }

    /* Layout */
    .grid{display:grid; gap:16px}
    .kpis{grid-template-columns:repeat(2,minmax(0,1fr))}
    .two-col{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width: 900px){ .kpis,.two-col{grid-template-columns:1fr} }

    .card{
      background:var(--card); color:var(--ink);
      border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.15);
    }
    .card h3{margin:0 0 12px; font-size:16px; color:var(--muted); font-weight:700; letter-spacing:.02em}
    .kpi-value{font-size:28px; font-weight:800}
    .kpi-sub{color:var(--muted); font-size:12px; margin-top:4px}

    /* ‚ÄúCalendrier‚Äù J/V/S */
    .calendar{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
    }
    .col-head{
      background:#0b1220; color:#fff; border-radius:10px; padding:10px; text-align:center; font-weight:800;
    }
    .slot{
      background:#0b1220; color:#fff; border-radius:10px; padding:12px; text-align:center;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      gap:6px; min-height:72px; transition:transform .1s ease; cursor:pointer;
    }
    .slot:hover{transform:translateY(-2px)}
    .slot .date{font-weight:800}
    .slot .val{font-size:12px; color:#e5e7eb}
    .slot.lv0{background:#0b1220}
    .slot.lv1{background:#134e4a}
    .slot.lv2{background:#0ea5e9}
    .slot.lv3{background:#f59e0b}
    .slot.lv4{background:#ef4444}

    /* Listes + barres CSS (sans chips) */
    .list{display:flex; flex-direction:column; gap:12px}
    .row{
      display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center;
    }
    .row .name{font-weight:700}
    .row .nums{font-variant-numeric:tabular-nums; text-align:right; white-space:nowrap}
    .row .nums small{color:var(--muted)}
    .barwrap{grid-column:1/-1; background:#f3f4f6; border-radius:999px; overflow:hidden; height:10px}
    .bar{height:100%; background:linear-gradient(90deg,var(--bar),var(--bar2))}

    /* Footer total mois */
    .total-month{
      text-align:center; font-weight:800; color:#fff; margin:8px 0 0; font-size:18px
    }
  </style>
</head>
<body>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
    <div class="left-nav">
      <a href="index.html" class="back-link">&larr; Nouvelle vente</a> |
      <a href="all.html" class="back-link">üßæ Toutes les ventes</a>
    </div>
  </div>

  <h1>Statistiques des ventes</h1>

  <div class="controls">
    <label for="monthSelect">S√©lectionnez un mois :</label>
    <select id="monthSelect"></select>
  </div>

  <!-- KPI (2 tuiles seulement) -->
  <section class="grid kpis" id="kpiGrid">
    <div class="card"><h3>Total CHF</h3><div class="kpi-value" id="kpiTotal">‚Äî</div><div class="kpi-sub" id="kpiAvgDay">‚Äî</div></div>
    <div class="card"><h3>Disques vendus</h3><div class="kpi-value" id="kpiCount">‚Äî</div><div class="kpi-sub" id="kpiAvgTicket">‚Äî</div></div>
  </section>

  <!-- Calendrier J/V/S -->
  <section class="card">
    <h3>Jours ouverts (Jeudi / Vendredi / Samedi)</h3>
    <div class="calendar">
      <div class="col-head">Jeudi</div>
      <div class="col-head">Vendredi</div>
      <div class="col-head">Samedi</div>
      <div id="colThu"></div>
      <div id="colFri"></div>
      <div id="colSat"></div>
    </div>
  </section>

  <!-- Category / Style breakdown (barres uniquement) -->
  <section class="grid two-col">
    <div class="card">
      <h3>R√©partition par cat√©gorie</h3>
      <div id="catList" class="list"></div>
    </div>
    <div class="card">
      <h3>R√©partition par style</h3>
      <div id="styleList" class="list"></div>
    </div>
  </section>

  <div id="totalMonth" class="total-month"></div>

  <script>
    // --- Helpers ---
    const CHF = n => new Intl.NumberFormat('fr-CH',{style:'currency',currency:'CHF',maximumFractionDigits:2}).format(n);
    const pad = n => String(n).padStart(2,'0');

    // Data source
    const snapshots = JSON.parse(localStorage.getItem("savedSnapshots") || "[]");
    const monthSelect = document.getElementById("monthSelect");

    function monthKeyFromDate(d){ return d.getFullYear()+"-"+pad(d.getMonth()+1); }
    function toDayKey(d){ return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate()); }

    // Fill month dropdown
    (function populateMonths(){
      const set = new Set(snapshots.map(s => monthKeyFromDate(new Date(s.time))));
      const months = Array.from(set).sort().reverse();
      monthSelect.innerHTML = "";
      months.forEach(m=>{
        const [y,mo] = m.split("-");
        const op = document.createElement("option");
        op.value = m; op.textContent = `${mo}/${y}`;
        monthSelect.appendChild(op);
      });
      if(!months.length){
        const op = document.createElement("option");
        op.value=""; op.textContent="(aucune donn√©e)";
        monthSelect.appendChild(op);
      }
    })();

    const els = {
      kpiTotal: document.getElementById("kpiTotal"),
      kpiAvgDay: document.getElementById("kpiAvgDay"),
      kpiCount: document.getElementById("kpiCount"),
      kpiAvgTicket: document.getElementById("kpiAvgTicket"),
      colThu: document.getElementById("colThu"),
      colFri: document.getElementById("colFri"),
      colSat: document.getElementById("colSat"),
      catList: document.getElementById("catList"),
      styleList: document.getElementById("styleList"),
      totalMonth: document.getElementById("totalMonth"),
    };

    function filterByMonth(mkey){
      return snapshots.filter(s=>{
        const d = new Date(s.time);
        return monthKeyFromDate(d) === mkey;
      });
    }

    function summarize(data){
      const byDay = {};
      const byCatC = {}, byCatS = {};
      const byStyleC = {}, byStyleS = {};

      let totalSales=0, totalCount=0;
      data.forEach(s=>{
        const d = new Date(s.time);
        const dayKey = toDayKey(d);
        let sub=0, cnt=0;
        s.entries.forEach(e=>{
          const price = parseFloat(e.price)||0;
          const cat = e.category || "‚Äî";
          const st = e.style || "‚Äî";
          totalSales += price; totalCount++;
          sub += price; cnt++;

          byCatC[cat]=(byCatC[cat]||0)+1;
          byCatS[cat]=(byCatS[cat]||0)+price;

          byStyleC[st]=(byStyleC[st]||0)+1;
          byStyleS[st]=(byStyleS[st]||0)+price;
        });
        if(!byDay[dayKey]) byDay[dayKey]={ total:0, count:0 };
        byDay[dayKey].total+=sub; byDay[dayKey].count+=cnt;
      });

      return { totalSales, totalCount, byDay, byCatC, byCatS, byStyleC, byStyleS };
    }

    function renderKPI(sum, mkey){
      // Nombre de jours ouverts r√©ellement pr√©sents dans les donn√©es (J/V/S)
      const openDays = Object.keys(sum.byDay).filter(k=>{
        const d = new Date(k+"T00:00:00");
        const dow = d.getDay(); // 0=dim..6=sam
        return (dow===4 || dow===5 || dow===6);
      });
      const days = openDays.length || 1;

      els.kpiTotal.textContent = CHF(sum.totalSales);
      els.kpiAvgDay.textContent = `Moyenne par jour ouvert: ${CHF(sum.totalSales/days)}`;
      els.kpiCount.textContent = sum.totalCount.toString();
      els.kpiAvgTicket.textContent = `Ticket moyen: ${sum.totalCount? CHF(sum.totalSales/sum.totalCount): '‚Äî'}`;

      const [y,mo] = mkey.split("-");
      els.totalMonth.textContent = `Total ${mo}/${y} ‚Äî ${sum.totalCount} disques | ${CHF(sum.totalSales)}`;
    }

    function addSlot(colEl, day, count, total, max){
      const slot = document.createElement('div');
      const ratio = total / (max || 1);
      let lv = 0;
      if (ratio === 0) lv = 0;
      else if (ratio < .25) lv = 1;
      else if (ratio < .5) lv = 2;
      else if (ratio < .8) lv = 3;
      else lv = 4;
      slot.className = `slot lv${lv}`;
      slot.title = `Jour ${day.toLocaleDateString('fr-CH')} ‚Ä¢ ${count} disques ‚Äî ${CHF(total)}`;
      slot.innerHTML = `<div class="date">${day.getDate()}</div><div class="val">${count} | ${CHF(total)}</div>`;
      colEl.appendChild(slot);
    }

    function renderJVScalendar(sum, mkey){
      els.colThu.innerHTML=""; els.colFri.innerHTML=""; els.colSat.innerHTML="";
      const [y,mo] = mkey.split("-").map(Number);
      const first = new Date(y, mo-1, 1);
      const last = new Date(y, mo, 0);

      // max des totaux J/V/S pour l‚Äôintensit√©
      const totals = [];
      for(let day=1; day<=last.getDate(); day++){
        const d = new Date(y, mo-1, day);
        const key = toDayKey(d);
        const info = sum.byDay[key] || {total:0, count:0};
        const dow = d.getDay(); // 0 dim .. 6 sam
        if(dow===4 || dow===5 || dow===6){ totals.push(info.total); }
      }
      const max = Math.max(1, ...totals, 0);

      // Remplir colonnes J/V/S
      for(let day=1; day<=last.getDate(); day++){
        const d = new Date(y, mo-1, day);
        const key = toDayKey(d);
        const info = sum.byDay[key] || {total:0, count:0};
        const dow = d.getDay();
        if(dow===4){ addSlot(els.colThu, d, info.count, info.total, max); }
        if(dow===5){ addSlot(els.colFri, d, info.count, info.total, max); }
        if(dow===6){ addSlot(els.colSat, d, info.count, info.total, max); }
      }
    }

    function renderBreakdown(containerList, counts, sums, totalSales){
      const items = Object.keys(counts).map(k=>({
        name:k, count:counts[k], sum:sums[k]||0
      })).sort((a,b)=> b.sum - a.sum);

      containerList.innerHTML = "";
      const maxSum = Math.max(1, ...items.map(i=>i.sum));

      items.forEach(i=>{
        const row = document.createElement('div');
        row.className = 'row';
        const share = totalSales? (i.sum/totalSales*100):0;
        row.innerHTML = `
          <div class="name">${i.name}</div>
          <div class="nums"><strong>${i.count}</strong> <small>disques</small></div>
          <div class="nums"><strong>${CHF(i.sum)}</strong> <small>${share.toFixed(1)}%</small></div>
          <div class="barwrap"><div class="bar" style="width:${(i.sum/maxSum*100).toFixed(0)}%"></div></div>
        `;
        containerList.appendChild(row);
      });
    }

    function renderAll(){
      const mkey = monthSelect.value || monthKeyFromDate(new Date());
      const data = filterByMonth(mkey);
      const sum = summarize(data);
      renderKPI(sum, mkey);
      renderJVScalendar(sum, mkey);
      renderBreakdown(els.catList, sum.byCatC, sum.byCatS, sum.totalSales);
      renderBreakdown(els.styleList, sum.byStyleC, sum.byStyleS, sum.totalSales);
    }

    monthSelect.addEventListener('change', renderAll);
    renderAll();
  </script>
</body>
</html>
